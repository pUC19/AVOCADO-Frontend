{% extends "base.html" %}
{% block title %}OT‑Auswertung (Excel) – ΔLc & Plots{% endblock %}

{% block content %}
<h1 class="section-title h3 mb-3">OT‑Auswertung aus Excel</h1>

<div class="card card-glass">
  <div class="card-body">
    <p class="text-muted mb-3">
      Lade eine bestehende Ergebnis‑<strong>.xlsx</strong>‑Datei hoch (z. B. aus deiner automatischen Analyse).
      Die App berechnet <strong>ΔLc</strong>, erzeugt <strong>KDE</strong>‑ und <strong>Scatter</strong>‑Plots
      und gibt ein neues Excel mit <em>eingebetteten</em> Grafiken zurück.
    </p>

    <form id="form" onsubmit="return false;" class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Excel‑Datei (.xlsx)</label>
        <input type="file" id="xlsx" class="form-control" accept=".xlsx" required>
      </div>
      <div class="col-md-4 d-grid align-items-end">
        <button id="run" class="btn btn-success mt-md-4">Auswertung starten</button>
      </div>
    </form>

    <progress id="prog" max="100" value="0" class="w-100 mt-3" style="display:none;"></progress>
    <div id="status" class="small text-muted mt-2"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById("form");
const btn  = document.getElementById("run");
const inp  = document.getElementById("xlsx");
const prog = document.getElementById("prog");
const statusEl = document.getElementById("status");

btn.addEventListener("click", async ()=>{
  const file = inp.files?.[0];
  if(!file){ alert("Bitte eine .xlsx-Datei auswählen."); return; }
  if(!file.name.toLowerCase().endsWith(".xlsx")){ alert("Nur .xlsx wird unterstützt."); return; }

  statusEl.textContent = "Wird verarbeitet …";
  prog.style.display = ""; prog.value = 15;

  const fd = new FormData();
  fd.append("file", file);

  try{
    const res = await fetch("/api/ot/analyze_excel", { method:"POST", body: fd });
    if(!res.ok){
      const j = await res.json().catch(()=>({error: res.statusText}));
      alert("Fehler: " + (j.error || res.status));
      statusEl.textContent = "Fehlgeschlagen.";
      prog.style.display = "none";
      return;
    }
    prog.value = 85;
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const base = file.name.replace(/\.xlsx$/i, "") + "_OT-Auswertung_DeltaLC.xlsx";
    a.download = base;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    statusEl.textContent = "Fertig. Datei heruntergeladen.";
    prog.value = 100;
    setTimeout(()=>prog.style.display = "none", 1200);
  }catch(e){
    console.error(e);
    alert("Unerwarteter Fehler.");
    statusEl.textContent = "Fehlgeschlagen.";
    prog.style.display = "none";
  }
});
</script>
{% endblock %}
